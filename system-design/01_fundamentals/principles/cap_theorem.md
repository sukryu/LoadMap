# CAP 정리 (CAP Theorem)

CAP 정리는 분산 시스템 설계에서 **일관성(Consistency)**, **가용성(Availability)**, **파티션 허용성(Partition Tolerance)** 이 세 가지 속성 간의 상충 관계를 설명하는 이론입니다.  
즉, 네트워크 분할(Partition)이 발생하는 상황에서는 이 세 가지 속성을 동시에 모두 만족시킬 수 없으며, 두 가지를 선택해야 한다는 것을 의미합니다.

---

## 1. 개념 개요

분산 시스템은 여러 노드가 네트워크를 통해 데이터를 공유하며 운영됩니다.  
이런 환경에서는 네트워크 장애나 분할(Partition)이 발생할 수 있으며, 이때 아래 세 가지 요소를 고려해야 합니다:

- **일관성 (Consistency):**  
  모든 노드가 동일한 데이터 상태를 유지하여, 어떤 클라이언트가 접근하더라도 같은 데이터를 읽을 수 있어야 합니다.

- **가용성 (Availability):**  
  모든 요청에 대해 항상 응답을 제공하여, 서비스 중단 없이 시스템이 지속적으로 운영되어야 합니다.

- **파티션 허용성 (Partition Tolerance):**  
  네트워크 분할(노드 간 통신 장애) 상황에서도 시스템이 정상적으로 동작해야 합니다.

**핵심:**  
네트워크 분할 상황에서는 일관성과 가용성 중 하나를 선택해야 하며, 두 가지 모두를 완벽하게 달성하는 것은 불가능합니다.

---

## 2. CAP 요소의 상세 설명

### 2.1. 일관성 (Consistency)
- **정의:**  
  모든 클라이언트가 동일한 시점에 같은 데이터 값을 보게 하는 것.  
  예를 들어, 은행 계좌 잔액이 한 사용자는 100원, 다른 사용자는 150원으로 보인다면 일관성이 깨진 것입니다.
- **장점:**  
  데이터 무결성과 신뢰성을 보장합니다.
- **단점:**  
  높은 일관성을 유지하기 위해서는 데이터 동기화에 따른 응답 지연이 발생할 수 있습니다.

### 2.2. 가용성 (Availability)
- **정의:**  
  시스템이 항상 요청에 대해 응답을 반환하는 것.  
  네트워크 장애나 일부 노드의 실패에도 불구하고, 서비스가 계속 제공되어야 합니다.
- **장점:**  
  사용자 경험을 향상시키고, 서비스 중단 없이 운영할 수 있습니다.
- **단점:**  
  가용성을 극대화할 경우, 최신 데이터가 반영되지 않은 응답(일관성 저하)이 발생할 수 있습니다.

### 2.3. 파티션 허용성 (Partition Tolerance)
- **정의:**  
  네트워크 분할이나 일부 노드 간의 통신 장애가 발생해도 시스템이 계속 동작하는 능력입니다.
- **장점:**  
  네트워크 문제나 일부 장애 상황에서도 시스템 전체의 운영을 보장합니다.
- **단점:**  
  파티션 발생 시, 일관성과 가용성 중 한 가지를 포기해야 하는 상황에 직면합니다.

---

## 3. CAP 정리의 의미 및 적용

### 3.1. 트레이드오프 결정
- **네트워크 분할이 없는 경우:**  
  이론적으로 일관성과 가용성을 모두 만족시킬 수 있습니다.
  
- **네트워크 분할이 발생하는 경우:**  
  시스템은 아래 두 가지 중 하나를 선택해야 합니다.
  - **CP (Consistency + Partition Tolerance):**  
    - **특징:** 일관성을 유지하기 위해 가용성을 희생합니다.  
    - **적용 예:** 금융 시스템, 은행 거래 등에서는 데이터의 정확성과 일관성이 가장 중요합니다.
    
  - **AP (Availability + Partition Tolerance):**  
    - **특징:** 가용성을 유지하기 위해 일관성이 잠시 미흡할 수 있습니다.  
    - **적용 예:** 소셜 미디어, 콘텐츠 배포 네트워크 등에서는 빠른 응답이 중요하며, 최종적으로 일관성을 맞추는 eventual consistency 방식을 적용할 수 있습니다.

### 3.2. 실제 적용 사례
- **Netflix:**  
  Netflix와 같은 스트리밍 서비스는 사용자가 중단 없는 스트리밍을 경험할 수 있도록 AP 방식을 채택하고, 데이터 일관성은 eventual consistency로 해결합니다.
  
- **금융 시스템:**  
  은행이나 결제 시스템은 CP 방식을 선택하여, 네트워크 장애 상황에서도 데이터 일관성을 최우선으로 유지합니다.

### 3.3. 현실 세계의 적용
현실에서는 CAP 정리의 세 요소를 엄격하게 나누기보다는,  
시스템의 목적과 환경에 따라 **부분적 타협**을 이루며 운영하는 경우가 많습니다.  
예를 들어, **eventual consistency**(최종적 일관성) 개념을 통해, 일정 시간 내에 데이터의 일관성을 맞추는 전략을 사용하기도 합니다.

---

## 4. 추가 고려 사항

- **성능과 응답 지연:**  
  높은 일관성을 유지하려면 동기화 비용이 발생해 응답 지연이 발생할 수 있습니다.  
  반면, 가용성을 높이면 최신 데이터가 반영되지 않을 위험이 있습니다.
  
- **네트워크 환경 분석:**  
  분산 시스템이 운영되는 네트워크의 특성과 장애 가능성을 고려하여, 적절한 CAP 요소의 균형을 맞추어야 합니다.
  
- **테스트와 모니터링:**  
  시스템이 CAP 정리에서 선택한 트레이드오프에 따라 올바르게 동작하는지 단위 테스트와 모니터링 체계를 구축해야 합니다.

---

## 5. 결론

CAP 정리는 분산 시스템 설계 시 고려해야 할 중요한 이론적 토대입니다.  
- **일관성, 가용성, 파티션 허용성** 중에서, 네트워크 분할 상황에서는 반드시 두 가지 속성 중 하나를 선택해야 합니다.  
- 각 시스템의 특성과 요구사항에 따라 CP 또는 AP 방식을 선택하고, 필요에 따라 eventual consistency와 같은 전략을 적용함으로써  
  안정적이고 효율적인 분산 시스템을 구축할 수 있습니다.

CAP 정리를 깊이 이해하고 이를 설계에 반영하면, 네트워크 장애와 같은 예기치 않은 상황에서도 시스템의 안정성과 성능을 최적화할 수 있습니다.

---

## 참고 자료

- **Designing Data-Intensive Applications** - Martin Kleppmann  
- [CAP Theorem Explained](https://www.infoq.com/articles/cap-twelve-years-of-distributed-systems/)
- [Understanding CAP Theorem](https://www.redhat.com/en/topics/cloud-native-apps/what-is-the-cap-theorem)