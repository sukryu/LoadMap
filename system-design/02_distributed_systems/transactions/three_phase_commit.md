# Three-Phase Commit (3PC)

> **목표:**  
> - 분산 트랜잭션 환경에서 2PC의 한계를 보완하는 3PC 프로토콜의 개념과 동작 원리를 이해한다.  
> - 각 단계(Prepare, Pre-Commit, Commit)를 통한 트랜잭션 처리 과정을 학습하고, 장애 발생 시의 대응 방안을 분석한다.  
> - 3PC의 장단점을 파악하고, 실제 분산 시스템 설계 시 고려해야 할 사항을 도출한다.

---

## 1. 개념 개요

> **3PC는 분산 트랜잭션의 원자성을 보장하면서 2PC에서 발생할 수 있는 블로킹 문제를 완화하기 위해 고안된 확장된 커밋 프로토콜이다.**

- **정의:**  
  - Three-Phase Commit(3PC)은 분산 트랜잭션의 커밋을 위해 세 가지 단계(Prepare, Pre-Commit, Commit)를 거치며, 각 참여 노드가 상태를 점진적으로 전환하여 최종 커밋이나 롤백 결정을 내리는 프로토콜입니다.
  
- **왜 중요한가?**  
  - **블로킹 완화:** 2PC에서는 Coordinator 장애 시 일부 참여 노드가 무한 대기 상태에 빠질 수 있지만, 3PC는 추가 단계(Pre-Commit)를 도입하여 이러한 블로킹 상황을 최소화합니다.
  - **향상된 장애 복구:** 각 단계에서 참여 노드가 현재 상태를 명시적으로 기록하고 공유하므로, 장애 발생 시 복구가 보다 원활하게 진행됩니다.
  - **데이터 정합성 유지:** 모든 노드가 최종 결정을 내리기 전에 충분한 준비 단계를 거치므로, 트랜잭션의 원자성과 데이터 정합성을 보다 확실하게 보장할 수 있습니다.

---

## 2. 구성 요소 및 역할

3PC의 기본 구성 요소는 2PC와 유사하며, Coordinator와 Participant가 존재합니다.

### 2.1 Coordinator (조정자)
- **역할:**  
  - 전체 트랜잭션을 관리하며, 각 단계별 메시지를 전송하고 참여 노드의 응답을 모니터링합니다.
  - Prepare, Pre-Commit, Commit 단계에서 참여자들이 올바른 상태로 전환되도록 조율합니다.

### 2.2 Participant (참여자)
- **역할:**  
  - Coordinator의 요청에 따라 로컬 트랜잭션 상태를 준비하고, 각 단계별로 자신의 상태를 전환합니다.
  - 각 단계에서 자신의 상태(Prepared, Pre-Committed, Committed 또는 Aborted)를 기록하고 Coordinator에게 보고합니다.

---

## 3. 3PC의 동작 과정

3PC는 세 단계로 나누어져 있으며, 각 단계에서 상태 전이가 명시적으로 이루어집니다.

### 3.1 Phase 1: Prepare (준비 단계)
- **과정:**  
  1. **Coordinator가 Prepare 메시지 전송:**  
     - 트랜잭션 커밋을 시작하기 위해 모든 Participant에게 Prepare 메시지를 전송합니다.
  2. **Participant의 로컬 준비:**  
     - 각 Participant는 로컬 트랜잭션을 커밋할 준비 상태(Prepared)로 전환하고, 해당 상태를 Coordinator에게 보고합니다.
  3. **응답 확인:**  
     - Coordinator가 모든 Participant로부터 Prepared 응답을 받으면, 다음 단계로 진행합니다.

### 3.2 Phase 2: Pre-Commit (사전 커밋 단계)
- **과정:**  
  1. **Coordinator가 Pre-Commit 메시지 전송:**  
     - 모든 Participant가 Prepared 상태임을 확인한 후, Coordinator는 Pre-Commit 메시지를 전송하여 각 Participant가 로컬 트랜잭션을 임시 커밋 상태(Pre-Committed)로 전환하도록 지시합니다.
  2. **Participant의 상태 전환:**  
     - 각 Participant는 Pre-Committed 상태로 전환하고, 이를 Coordinator에 보고합니다.
  3. **안정성 확인:**  
     - 이 단계에서 모든 노드가 Pre-Committed 상태임을 확인한 후, 최종 커밋 단계로 진입합니다.

### 3.3 Phase 3: Commit (커밋 단계)
- **과정:**  
  1. **Coordinator의 최종 결정:**  
     - 모든 Participant로부터 Pre-Committed 응답을 받으면, Coordinator는 최종 커밋을 결정하고 Commit 메시지를 전송합니다.
     - 만약 어느 한 곳에서라도 문제가 발생하면, Coordinator는 롤백(Abort) 메시지를 전송하여 전체 트랜잭션을 취소합니다.
  2. **Participant의 최종 처리:**  
     - 각 Participant는 최종 메시지에 따라 로컬 트랜잭션을 커밋(Committed)하거나 롤백(Aborted)합니다.

---

## 4. 장단점 및 고려 사항

### 장점
- **블로킹 완화:**  
  - 3PC는 Pre-Commit 단계 도입을 통해 Coordinator 장애나 네트워크 문제 발생 시에도 각 노드가 명시적 상태를 공유하여 블로킹 상황을 최소화합니다.
  
- **향상된 장애 복구:**  
  - 각 단계별로 상태 전이가 명확하게 이루어지므로, 장애 발생 시 어느 단계에서 중단되었는지 파악이 용이하며, 복구 프로세스가 개선됩니다.
  
- **데이터 정합성 보장:**  
  - 준비와 사전 커밋 단계를 통해 모든 노드가 동일한 결정을 내리기 위한 충분한 검증 과정을 거치므로, 최종 커밋 시 데이터 정합성이 보장됩니다.

### 단점
- **네트워크 오버헤드:**  
  - 세 단계에 걸친 메시지 교환과 상태 전이가 추가되므로, 2PC에 비해 네트워크 통신 오버헤드가 증가합니다.
  
- **복잡성 증가:**  
  - 3단계의 상태 전이와 추가적인 오류 처리 로직으로 인해 프로토콜 구현과 운영이 복잡해집니다.
  
- **성능 저하:**  
  - 각 단계별 동기화 과정이 추가되면서 전체 트랜잭션 처리 시간이 증가할 수 있습니다.

### 고려 사항
- **환경에 따른 선택:**  
  - 트랜잭션의 중요도와 네트워크 안정성, 장애 발생 가능성 등을 고려하여 3PC가 적합한지 판단해야 합니다.
  
- **타임아웃 및 장애 복구:**  
  - 각 단계에서 타임아웃을 적절히 설정하고, 장애 발생 시 상태 복구 절차를 마련해야 합니다.
  
- **시스템 부하:**  
  - 빈번한 트랜잭션 처리나 대규모 분산 환경에서는 3PC의 오버헤드가 성능에 미치는 영향을 고려해야 합니다.

---

## 5. 참고 자료

- 📖 _Designing Data-Intensive Applications_ - Martin Kleppmann  
- 📖 _Distributed Systems: Principles and Paradigms_ - Andrew S. Tanenbaum  
- 📌 [Three-Phase Commit Protocol (논문 및 기술 자료)](https://www.ibm.com/docs/en/cics-ts/5.3?topic=protocols-three-phase-commit)

---

## 6. 마무리

3PC는 분산 트랜잭션의 원자성과 데이터 정합성을 보장하면서, 2PC에서 발생할 수 있는 블로킹 문제를 완화하기 위해 고안된 프로토콜입니다.  
세 단계의 Prepare, Pre-Commit, Commit 과정을 통해 각 참여 노드가 명시적인 상태를 공유하고, 장애 발생 시 보다 유연한 복구가 가능합니다.  
하지만 네트워크 오버헤드와 프로토콜 복잡성이 증가하므로, 실제 시스템 설계 시 트랜잭션의 특성과 운영 환경을 신중하게 고려하여 사용해야 합니다.