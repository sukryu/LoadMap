# 실무에서의 분산 트랜잭션 적용

> **목표:**  
> - 분산 시스템 환경에서 데이터 정합성과 원자성을 유지하기 위한 트랜잭션 처리 전략을 이해한다.  
> - 글로벌 트랜잭션과 로컬 트랜잭션의 차이와 각각의 장단점을 분석한다.  
> - Kafka, RabbitMQ 등 이벤트 기반 미들웨어와 전통적인 2PC/3PC, SAGA 패턴을 활용한 분산 트랜잭션 적용 사례를 학습한다.

---

## 1. 개념 및 필요성

분산 시스템에서는 여러 노드나 서비스가 서로 다른 데이터 저장소를 운영하면서 동시에 작업을 수행하게 됩니다.  
이때 데이터의 일관성과 원자성을 보장하기 위해 트랜잭션 관리가 매우 중요합니다.  
실무에서는 다음과 같은 문제를 해결하기 위해 분산 트랜잭션 적용 전략을 도입합니다.

- **데이터 정합성 유지:**  
  - 여러 서비스 및 데이터 저장소에 걸친 작업이 모두 성공하거나 모두 실패하도록 보장해야 합니다.
  
- **장애 대응 및 롤백:**  
  - 한 서비스의 장애나 네트워크 문제 발생 시, 전체 트랜잭션을 안전하게 롤백하여 데이터 불일치를 방지합니다.
  
- **서비스 특성 반영:**  
  - 금융, 전자상거래와 같이 높은 원자성이 요구되는 경우와, 빠른 응답성과 확장성이 중요한 경우에 따라 적절한 트랜잭션 전략을 선택합니다.

---

## 2. 적용 전략 및 접근 방식

### 2.1 전통적인 분산 트랜잭션 프로토콜 (2PC / 3PC)
- **2PC (Two-Phase Commit):**  
  - Coordinator와 여러 Participant가 두 단계(Prepare, Commit)를 거쳐 트랜잭션을 원자적으로 커밋합니다.
  - 장점: 원자성 보장, 데이터 정합성 유지  
  - 단점: Coordinator 단일 장애, 블로킹 문제, 네트워크 지연에 민감
- **3PC (Three-Phase Commit):**  
  - 2PC의 한계를 보완하기 위해 Pre-Commit 단계를 추가하여 블로킹 문제를 완화합니다.
  - 장점: 장애 발생 시 보다 유연한 복구, 상태 전이 명시  
  - 단점: 추가 네트워크 오버헤드, 복잡성 증가

### 2.2 SAGA 패턴
- **SAGA 패턴:**  
  - 글로벌 트랜잭션 대신 여러 로컬 트랜잭션으로 나누어 각 단계마다 독립적으로 실행하고, 실패 시 보상 트랜잭션을 실행하여 전체 트랜잭션을 롤백합니다.
- **구현 방식:**  
  - **오케스트레이션 방식:** 중앙 조정자(Orchestrator)가 각 단계의 로컬 트랜잭션을 순차적으로 실행 및 보상 트랜잭션을 호출합니다.
  - **체인 방식:** 각 서비스가 자신의 로컬 트랜잭션 성공 후 이벤트를 발생시켜, 다음 서비스가 이를 수신하고 처리하는 방식으로 진행합니다.
- **장점:**  
  - 마이크로서비스 환경에 적합, 서비스 간 결합도 낮춤, 장애 격리 및 부분 복구 가능
- **단점:**  
  - 보상 트랜잭션 설계가 복잡, 일시적 데이터 불일치 가능

### 2.3 이벤트 기반 트랜잭션 처리
- **메시지 큐 활용:**  
  - Kafka, RabbitMQ 등 메시지 큐 시스템을 사용하여, 트랜잭션 관련 이벤트를 비동기적으로 처리합니다.
  - 각 서비스는 자신의 작업 결과를 메시지로 발행하고, 구독한 다른 서비스가 이를 기반으로 후속 작업을 수행합니다.
- **장점:**  
  - 높은 확장성, 비동기 처리로 인한 응답 시간 개선
  - 장애 시 재처리 및 복구 메커니즘을 쉽게 적용할 수 있음
- **단점:**  
  - 이벤트 순서 보장 문제, 복잡한 상태 관리 필요

---

## 3. 실무 적용 사례

- **Google Spanner:**  
  - 글로벌 분산 트랜잭션을 위해 강한 일관성과 동기 복제를 활용, 전통적인 2PC/3PC 개념을 기반으로 설계.
  
- **Amazon DynamoDB:**  
  - SAGA 패턴과 튜너블 일관성 모델을 통해 높은 확장성과 성능을 유지하면서도, 필요한 경우 보상 트랜잭션으로 데이터 정합성을 보장.
  
- **Uber:**  
  - 마이크로서비스 아키텍처 환경에서 SAGA 패턴을 도입하여, 각 서비스 간 분산 트랜잭션을 관리. 장애 발생 시 보상 트랜잭션을 실행하여 주문 처리 및 결제 프로세스의 원자성을 유지.
  
- **이벤트 기반 시스템:**  
  - 금융 결제나 실시간 로그 처리 등에서 Kafka를 이용하여 트랜잭션 관련 이벤트를 발행하고, 각 서비스가 이를 처리하는 방식으로 트랜잭션을 관리.

---

## 4. 모니터링 및 테스트 전략

- **실시간 모니터링:**  
  - Prometheus, Grafana 등을 활용하여 각 서비스의 트랜잭션 상태, 메시지 처리 지연, 보상 트랜잭션 실행 여부 등을 모니터링합니다.
  
- **장애 시뮬레이션:**  
  - Chaos Engineering 기법을 적용하여 네트워크 장애, 서비스 중단 등의 시나리오를 테스트하고, 트랜잭션 복구 및 보상 전략의 효과를 검증합니다.
  
- **성능 테스트:**  
  - 부하 테스트 및 스트레스 테스트를 통해, 선택한 트랜잭션 처리 전략이 시스템 전체 성능에 미치는 영향을 분석합니다.

---

## 5. 고려 사항 및 트레이드오프

- **서비스 특성에 따른 전략 선택:**  
  - 데이터 정합성이 극도로 중요한 서비스는 강한 일관성을 유지하는 전통적 트랜잭션 프로토콜(2PC/3PC)을, 빠른 응답과 높은 가용성이 중요한 서비스는 SAGA 패턴이나 이벤트 기반 트랜잭션 처리를 선택합니다.
  
- **네트워크 환경과 장애 대응:**  
  - 분산 환경에서는 네트워크 지연, 파티션 및 노드 장애가 빈번하게 발생할 수 있으므로, 이에 대한 대비책(타임아웃, 재시도, 보상 트랜잭션 설계)을 마련해야 합니다.
  
- **시스템 복잡도:**  
  - 글로벌 트랜잭션을 전역적으로 관리하는 것은 구현과 운영 측면에서 복잡성이 증가하므로, 필요에 따라 로컬 트랜잭션으로 분리하고 보상 트랜잭션을 활용하는 전략을 고려합니다.

---

## 6. 참고 자료

- 📖 _Designing Data-Intensive Applications_ - Martin Kleppmann  
- 📖 _Distributed Systems: Principles and Paradigms_ - Andrew S. Tanenbaum  
- 📖 _Database Internals_ - Alex Petrov  
- 📌 [Two-Phase Commit Explained](https://www.ibm.com/docs/en/cics-ts/5.3?topic=processing-two-phase-commit)  
- 📌 [SAGA Pattern in Microservices](https://microservices.io/patterns/data/saga.html)

---

## 7. 마무리

실무에서의 분산 트랜잭션 적용은 서비스의 요구사항, 데이터 정합성, 응답 시간, 장애 대응 등을 종합적으로 고려하여 적절한 전략을 선택하는 것이 핵심입니다.  
전통적인 2PC/3PC 프로토콜과 SAGA 패턴, 그리고 이벤트 기반 처리 방식을 적절히 혼합하여 사용하면, 분산 환경에서도 원자성, 정합성, 가용성을 효과적으로 유지할 수 있습니다.  
이 문서를 통해 각 접근 방식의 특징과 실무 적용 시 고려해야 할 사항들을 명확히 이해하고, 실제 시스템 설계에 반영할 수 있기를 바랍니다.