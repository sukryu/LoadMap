# Two-Phase Commit (2PC)

> **목표:**  
> - 분산 트랜잭션 환경에서 모든 관련 노드가 하나의 트랜잭션에 대해 원자적인 커밋을 수행하도록 보장하는 2PC 프로토콜을 이해한다.  
> - Coordinator와 Participant 간의 상호작용과 각 단계에서 수행되는 작업을 학습한다.  
> - 2PC의 한계점과 이를 보완하기 위한 전략을 분석한다.

---

## 1. 개념 개요

> **2PC는 분산 트랜잭션의 원자성을 보장하기 위해, Coordinator가 참여 노드(Participant)들과 2단계에 걸쳐 커밋을 조정하는 프로토콜이다.**

- **정의:**  
  - Two-Phase Commit(2PC)은 여러 노드에 걸친 트랜잭션의 커밋 또는 롤백을 원자적으로 처리하기 위해 두 단계(Prepare 단계와 Commit 단계)를 거치는 분산 트랜잭션 프로토콜입니다.
  
- **왜 중요한가?**  
  - 분산 시스템에서는 단일 데이터베이스와 달리, 여러 노드에서 동시에 데이터 변경이 일어나므로, 모든 노드가 동일한 상태로 전환되어야 합니다.  
  - 장애 발생 시 데이터 불일치 문제를 방지하고, 원자적 작업 수행을 보장하여 데이터 정합성을 유지합니다.

- **어떤 문제를 해결하는가?**  
  - 트랜잭션이 여러 노드에 걸쳐 수행되는 상황에서, 일부 노드만 커밋되거나 롤백되는 부분적인 실패를 방지합니다.
  - 장애 발생 시 모든 노드가 동일한 결정을 내리도록 함으로써, 데이터의 일관성을 보장합니다.

---

## 2. 구성 요소 및 역할

2PC는 크게 두 가지 주요 구성 요소로 이루어집니다.

### 2.1 Coordinator (조정자)
- **역할:**  
  - 전체 트랜잭션을 관리하고, 모든 참여자에게 커밋 여부를 결정하도록 명령합니다.
  - 트랜잭션의 준비(Prepare) 단계와 커밋(Commit) 단계를 조율합니다.
  
### 2.2 Participant (참여자)
- **역할:**  
  - Coordinator의 요청에 따라 트랜잭션 작업을 수행하고, 준비가 완료되었는지 여부를 보고합니다.
  - Coordinator의 최종 결정(커밋 또는 롤백)을 수신하여, 로컬 트랜잭션을 해당 결정에 맞춰 적용합니다.

---

## 3. 2PC의 동작 과정

2PC는 크게 두 단계로 구성됩니다.

### 3.1 Phase 1: Prepare (준비 단계)
- **과정:**  
  1. **Coordinator가 Prepare 메시지 전송:**  
     - Coordinator는 트랜잭션 커밋을 시작하기 위해 모든 Participant에게 Prepare 메시지를 전송합니다.
  2. **Participant의 작업 준비 및 응답:**  
     - 각 Participant는 자신의 로컬 트랜잭션을 커밋할 수 있는 상태로 준비하고, 성공적으로 준비되었으면 "준비 완료(Ready)" 메시지를 Coordinator에게 응답합니다.
     - 만약 어떤 Participant에서 문제가 발생하여 준비를 완료하지 못하면, "실패(Failure)" 메시지를 전송할 수 있습니다.

### 3.2 Phase 2: Commit (커밋 단계)
- **과정:**  
  1. **Coordinator의 결정:**  
     - 모든 Participant로부터 "준비 완료" 메시지를 받으면, Coordinator는 커밋을 결정하고 "커밋" 메시지를 모든 Participant에게 전송합니다.
     - 하나라도 "실패" 메시지를 받으면, Coordinator는 전체 트랜잭션을 롤백하도록 "롤백" 메시지를 전송합니다.
  2. **Participant의 최종 처리:**  
     - 각 Participant는 Coordinator의 최종 메시지에 따라 로컬 트랜잭션을 커밋하거나 롤백합니다.

---

## 4. 장단점 및 고려 사항

### 장점
- **원자성 보장:**  
  - 모든 참여자가 동일한 결정을 내리므로, 트랜잭션의 원자성을 보장할 수 있습니다.
- **데이터 정합성 유지:**  
  - 모든 노드가 커밋 또는 롤백 결정을 따르기 때문에, 분산 환경에서 데이터 일관성을 유지할 수 있습니다.

### 단점
- **블로킹 문제:**  
  - Coordinator 장애나 네트워크 지연 시, 일부 Participant가 무한 대기 상태에 빠질 수 있습니다.
- **단일 장애점 (SPOF):**  
  - Coordinator가 단일 장애점이 되어, 장애 발생 시 전체 트랜잭션이 중단될 수 있습니다.
- **성능 저하:**  
  - 동기적 커밋 방식으로 인해 네트워크 지연 및 추가적인 통신 오버헤드가 발생합니다.

### 고려 사항
- **Coordinator 장애 대비:**  
  - Coordinator 장애 시, 복구 프로토콜이나 타임아웃 설정을 통해 Participant가 롤백하도록 설계해야 합니다.
- **네트워크 안정성:**  
  - 네트워크 상태에 따라 트랜잭션 처리 시간이 달라질 수 있으므로, 네트워크 지연이나 파티션 발생에 대비한 모니터링이 필요합니다.
- **트랜잭션 크기 및 빈도:**  
  - 트랜잭션이 잦거나 크기가 큰 경우, 2PC의 성능 오버헤드를 감수해야 하므로, 필요에 따라 3PC나 SAGA 패턴과 같은 대안을 고려할 수 있습니다.

---

## 5. 실무 적용 사례

- **금융 시스템:**  
  - 분산 금융 거래 시스템에서 2PC를 사용하여 여러 계좌 간의 원자적 자금 이체를 보장합니다.
- **분산 데이터베이스:**  
  - 일부 전통적인 분산 데이터베이스에서는 2PC를 활용하여 여러 노드에 걸친 트랜잭션을 동기적으로 처리합니다.
- **클라우드 기반 애플리케이션:**  
  - 클라우드 서비스에서 데이터 정합성을 유지하기 위해, 중요 트랜잭션에 대해 2PC를 적용하는 사례가 존재합니다.

---

## 6. 참고 자료

- 📖 _Designing Data-Intensive Applications_ - Martin Kleppmann  
- 📖 _Distributed Systems: Principles and Paradigms_ - Andrew S. Tanenbaum  
- 📌 [Two-Phase Commit Explained (IBM)](https://www.ibm.com/docs/en/cics-ts/5.3?topic=processing-two-phase-commit)  
- 📌 [2PC와 관련된 온라인 자료 및 논문](http://www.cs.cmu.edu/~glens/paxos-simple.pdf) *(Paxos와의 비교를 위해 참고 가능)*

---

## 7. 마무리

2PC는 분산 트랜잭션의 원자성과 데이터 정합성을 보장하기 위한 전통적인 프로토콜로, Coordinator와 Participant 간의 2단계 커밋 과정을 통해 모든 노드가 동일한 결정을 내리도록 합니다.  
하지만 블로킹 문제와 단일 장애점 등의 단점을 가지므로, 실제 시스템 설계 시 네트워크 상태와 트랜잭션 특성을 신중하게 고려하여 사용해야 합니다.  