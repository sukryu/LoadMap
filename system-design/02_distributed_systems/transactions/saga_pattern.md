# SAGA 패턴

> **목표:**  
> - 분산 환경에서 롱 러닝 트랜잭션을 효과적으로 관리하는 SAGA 패턴의 개념과 필요성을 이해한다.  
> - SAGA 패턴의 구성 요소와 각 트랜잭션 단계에서 수행되는 보상(Compensating) 트랜잭션의 역할을 학습한다.  
> - 마이크로서비스 아키텍처에서 SAGA 패턴을 활용한 트랜잭션 관리 방법과 실무 적용 전략을 분석한다.

---

## 1. 개념 개요

> **SAGA 패턴은 분산 트랜잭션을 여러 개의 독립적인 로컬 트랜잭션으로 나누고, 각 단계에서 문제가 발생할 경우 보상 트랜잭션을 실행하여 전체 트랜잭션의 원자성을 간접적으로 보장하는 패턴이다.**

- **정의:**  
  - SAGA 패턴은 단일 글로벌 트랜잭션 대신, 여러 개의 로컬 트랜잭션으로 구성된 일련의 작업으로 트랜잭션을 수행하며, 각 로컬 트랜잭션이 성공하면 다음 단계로 진행되고, 실패 시 보상(Compensating) 트랜잭션을 실행하여 이전 상태로 복구하는 방식입니다.

- **왜 중요한가?**  
  - **비동기적 처리:** 장기간 지속되는 트랜잭션을 비동기적으로 처리하여, 분산 시스템에서 높은 가용성과 확장성을 유지할 수 있습니다.  
  - **장애 격리:** 각 서비스가 독립적인 로컬 트랜잭션으로 동작하므로, 일부 서비스의 장애가 전체 트랜잭션에 영향을 미치지 않습니다.  
  - **유연성:** 트랜잭션을 여러 단계로 나누어 처리하기 때문에, 복잡한 비즈니스 로직과 장시간 작업을 효과적으로 관리할 수 있습니다.

- **어떤 문제를 해결하는가?**  
  - 단일 글로벌 트랜잭션이 실패할 경우 전체 롤백을 수행해야 하는 문제를 피하고, 각 서비스가 독립적으로 실패를 복구할 수 있도록 합니다.  
  - 분산 시스템에서 발생할 수 있는 네트워크 지연 및 장애 상황에서도 데이터 정합성을 유지할 수 있도록 지원합니다.

---

## 2. SAGA 패턴의 동작 원리

SAGA 패턴은 보통 두 가지 방식으로 구현됩니다: 오케스트레이션(Orchestration) 방식과 체인(Choreography) 방식.

### 2.1 오케스트레이션 방식 (Orchestration)
- **개념:**  
  - 중앙 조정자(Orchestrator)가 각 로컬 트랜잭션을 순차적으로 호출하고, 실패 시 보상 트랜잭션을 실행하는 방식입니다.
- **특징:**  
  - 중앙 집중적으로 트랜잭션 흐름을 관리하므로 전체 프로세스의 가시성이 높습니다.
  - 장애 발생 시 중앙 조정자가 즉각적으로 보상 트랜잭션을 실행하여 복구를 시도합니다.

### 2.2 체인 방식 (Choreography)
- **개념:**  
  - 각 서비스가 자신의 로컬 트랜잭션 성공 후, 다음 서비스를 호출하는 방식으로 트랜잭션 플로우가 자동으로 이어지는 방식입니다.
- **특징:**  
  - 중앙 조정자 없이 각 서비스 간 이벤트를 통해 트랜잭션이 진행됩니다.
  - 서비스 간 느슨한 결합(loose coupling)을 유지하여, 확장성과 유연성을 높일 수 있습니다.
  - 각 서비스는 자신의 보상 트랜잭션 로직을 포함하고 있어, 문제가 발생할 경우 스스로 이전 상태로 복구할 수 있습니다.

---

## 3. 장단점 및 고려 사항

### 장점
- **높은 확장성 및 가용성:**  
  - 각 서비스가 독립적으로 로컬 트랜잭션을 수행하므로, 전체 시스템의 가용성과 확장성이 향상됩니다.
  
- **장애 격리:**  
  - 개별 서비스의 장애가 전체 트랜잭션에 영향을 주지 않으므로, 실패 시에도 부분적인 복구가 가능합니다.
  
- **유연한 비즈니스 로직:**  
  - 복잡한 비즈니스 프로세스를 여러 단계로 나누어 처리할 수 있으며, 각 단계별로 보상 트랜잭션을 설계하여 더욱 유연한 오류 처리가 가능합니다.

### 단점
- **보상 트랜잭션 설계의 어려움:**  
  - 각 로컬 트랜잭션에 대응하는 보상 트랜잭션을 올바르게 설계하고 구현해야 하므로, 복잡성이 증가할 수 있습니다.
  
- **일관성 지연:**  
  - 모든 보상 트랜잭션이 실행되기 전까지는 데이터 일관성이 일시적으로 깨질 수 있습니다.
  
- **복잡한 상태 관리:**  
  - 트랜잭션이 여러 단계로 나뉘어 진행되기 때문에, 각 단계의 상태를 추적하고 관리하는 데 추가적인 오버헤드가 발생할 수 있습니다.

### 고려 사항
- **서비스 간 결합도:**  
  - 오케스트레이션 방식은 중앙 조정자에 의존하므로 단일 장애점(Single Point of Failure)이 발생할 수 있으며, 체인 방식은 이벤트 기반 통신에 따른 복잡성이 존재합니다.
  
- **비즈니스 요구사항 분석:**  
  - 애플리케이션의 특성과 비즈니스 요구사항에 따라, 글로벌 트랜잭션이 필요한지, 부분적 성공과 보상으로도 충분한지 신중하게 판단해야 합니다.
  
- **모니터링 및 복구 전략:**  
  - SAGA의 각 단계와 보상 트랜잭션의 실행 상태를 지속적으로 모니터링하고, 장애 발생 시 신속하게 대응할 수 있는 전략을 마련해야 합니다.

---

## 4. 실무 적용 사례

- **전자상거래 시스템:**  
  - 주문 생성, 결제, 재고 차감 등의 로컬 트랜잭션을 SAGA 패턴으로 관리하여, 일부 서비스 실패 시 보상 트랜잭션으로 롤백하여 주문 취소 등의 처리를 수행합니다.
  
- **금융 서비스:**  
  - 여러 금융 서비스 간의 복합 거래에서, 각 거래 단계가 독립적으로 실행되고 문제가 발생하면 보상 트랜잭션으로 이전 상태로 복구합니다.
  
- **마이크로서비스 아키텍처:**  
  - 다양한 서비스 간에 긴 트랜잭션을 처리할 때, SAGA 패턴을 적용하여 각 서비스의 독립성을 유지하면서 전체 트랜잭션의 일관성을 보장합니다.

---

## 5. 참고 자료

- 📖 _Designing Data-Intensive Applications_ - Martin Kleppmann  
- 📖 _Microservices Patterns: With examples in Java_ - Chris Richardson  
- 📌 [SAGA Pattern in Microservices](https://microservices.io/patterns/data/saga.html)  
- 온라인 자료: SAGA 관련 블로그 포스트 및 기술 문서

---

## 6. 마무리

SAGA 패턴은 분산 시스템, 특히 마이크로서비스 아키텍처에서 롱 러닝 트랜잭션을 효과적으로 관리하기 위한 강력한 전략입니다.  
각 로컬 트랜잭션과 대응하는 보상 트랜잭션을 통해, 전체 트랜잭션의 원자성을 간접적으로 보장하며, 장애 발생 시에도 시스템의 데이터 정합성을 유지할 수 있습니다.  
실무에서는 비즈니스 요구사항에 따라 오케스트레이션 방식과 체인 방식을 적절히 선택하고, 각 단계의 상태와 보상 트랜잭션을 면밀하게 설계하는 것이 중요합니다.