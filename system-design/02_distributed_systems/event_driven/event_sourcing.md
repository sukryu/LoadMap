# 이벤트 소싱 (Event Sourcing)

> **목표:**  
> - 이벤트 소싱의 개념과 핵심 원리를 이해한다.  
> - 전통적인 CRUD 방식과 이벤트 소싱 방식의 차이점을 분석한다.  
> - 이벤트 소싱을 활용하여 데이터 변경 이력을 기록하고, 상태 복원 및 감사(audit) 기능을 구현하는 방법을 학습한다.

---

## 1. 개념 개요

> **이벤트 소싱은 애플리케이션의 상태를 변경하는 모든 이벤트를 저장하고, 이를 기반으로 현재 상태를 재구성하는 데이터 관리 방식이다.**

- **정의:**  
  - 이벤트 소싱(Event Sourcing)은 데이터의 변경 내역(이벤트)를 순차적으로 저장하여, 시스템의 상태를 재생(Replaying Events)할 수 있도록 하는 아키텍처 패턴입니다.
  - 모든 상태 변경은 이벤트라는 불변의 기록으로 남기며, 데이터베이스의 현재 상태 대신 이벤트 로그가 단일 진실의 원천(Source of Truth)이 됩니다.

- **왜 중요한가?**  
  - **감사 및 추적:** 모든 상태 변경 이력이 이벤트로 기록되므로, 문제 발생 시 원인을 추적하거나 감사(audit)를 수행하기에 용이합니다.
  - **상태 재구성:** 시스템 장애나 복구 시 이벤트 로그를 재생하여 정확한 현재 상태를 복원할 수 있습니다.
  - **유연한 확장:** 이벤트 기반 시스템은 새로운 기능 추가나 변경 이력 분석에 유리하며, 데이터 분석 및 비즈니스 인사이트 도출에도 활용할 수 있습니다.

- **어떤 문제를 해결하는가?**  
  - 전통적인 CRUD 방식에서는 데이터의 최신 상태만 저장되므로, 변경 이력이나 이벤트 발생 순서를 알기 어렵습니다.
  - 이벤트 소싱은 변경 내역을 모두 기록하여, 시간에 따른 상태 변화를 명확하게 파악할 수 있게 합니다.

- **실무에서 어떻게 적용하는가?**  
  - 금융 거래, 주문 처리, 사용자 활동 로그 등 변경 이력을 추적해야 하는 도메인에서 활용됩니다.
  - 이벤트 소싱과 결합한 CQRS 패턴을 통해 읽기와 쓰기를 분리하여, 높은 확장성과 성능을 달성할 수 있습니다.

---

## 2. 이벤트 소싱의 동작 원리

- **이벤트 기록:**  
  - 모든 상태 변경(예: "주문 생성", "주문 취소", "잔액 변경")은 이벤트로 기록됩니다.  
  - 이벤트는 일반적으로 불변(Immutable)이며, 타임스탬프, 발생 원인, 관련 데이터 등을 포함합니다.

- **상태 재구성 (Rehydration):**  
  - 현재 상태는 이벤트 로그의 시퀀스를 순차적으로 재생(Replaying)하여 구성됩니다.  
  - 시스템 시작 시 또는 장애 복구 시, 모든 이벤트를 적용하여 최신 상태를 복원합니다.

- **이벤트 저장소:**  
  - 이벤트 로그는 별도의 스토리지(예: 이벤트 스토어, 로그 기반 데이터베이스)에 저장됩니다.
  - 이벤트 저장소는 내구성이 보장되어야 하며, 데이터 손실 없이 이벤트를 지속적으로 기록할 수 있어야 합니다.

- **이벤트 처리 및 구독:**  
  - 이벤트 버스나 메시지 큐를 통해 다른 서비스나 컴포넌트에 이벤트를 전달하여, 필요한 후속 처리를 수행합니다.
  - 이벤트 기반 아키텍처에서는 여러 컴포넌트가 이벤트를 구독하고, 자신의 로직에 따라 상태를 갱신하거나 부수 효과(side effects)를 발생시킵니다.

---

## 3. 전통적인 CRUD 방식과의 차이

- **CRUD 방식:**  
  - 데이터베이스는 현재 상태만 저장하며, 변경 이력은 별도의 로그나 감사 기록으로 관리됩니다.
  - 상태 변경에 대한 세부 내역을 기록하지 않기 때문에, 과거 상태로의 복원이 어렵습니다.

- **이벤트 소싱:**  
  - 모든 상태 변경이 이벤트로 저장되므로, 시스템의 모든 변경 이력을 완전하게 추적할 수 있습니다.
  - 과거 이벤트를 재생하여, 특정 시점의 상태를 재구성하거나 변경 내역을 분석할 수 있습니다.

---

## 4. 장단점 및 고려 사항

### 장점
- **감사 및 추적 용이:**  
  - 모든 이벤트가 기록되므로, 변경 내역과 원인 분석이 용이합니다.
- **상태 복원 및 재생:**  
  - 장애 발생 시 이벤트 로그를 통해 빠르게 상태를 복원할 수 있습니다.
- **비즈니스 인사이트 도출:**  
  - 이벤트 로그를 분석하여 사용자 행동, 시스템 성능 등의 다양한 인사이트를 얻을 수 있습니다.
- **확장성과 유연성:**  
  - CQRS와 결합하여 읽기와 쓰기를 분리, 성능 최적화 및 새로운 기능 추가에 유리합니다.

### 단점
- **이벤트 저장소 관리 복잡성:**  
  - 모든 이벤트를 영구적으로 저장해야 하므로, 데이터 저장 및 관리 비용이 증가할 수 있습니다.
- **이벤트 스키마 변경:**  
  - 시간이 지남에 따라 이벤트 구조가 변경될 경우, 기존 이벤트와의 호환성을 유지하기 위한 추가 작업이 필요합니다.
- **상태 재구성 비용:**  
  - 이벤트 로그가 길어질수록, 상태를 재생하는 과정이 느려질 수 있으며, 스냅샷(snapshot) 등의 기법을 통해 최적화해야 합니다.

### 고려 사항
- **이벤트 보존 정책:**  
  - 얼마나 오래 이벤트를 보존할지, 그리고 스냅샷을 어떻게 관리할지에 대한 전략이 필요합니다.
- **이벤트 버전 관리:**  
  - 이벤트 스키마 변경 시, 이전 버전과의 호환성을 유지할 수 있는 버전 관리 전략을 마련해야 합니다.
- **성능 최적화:**  
  - 이벤트 재생에 소요되는 시간을 단축하기 위해, 정기적인 스냅샷 생성 및 이벤트 로그 정리를 고려합니다.

---

## 5. 실무 적용 사례

- **금융 거래 시스템:**  
  - 모든 거래 내역을 이벤트로 기록하여, 감사 및 복구가 필요한 경우 과거 상태를 정확하게 재구성할 수 있습니다.
- **주문 처리 시스템:**  
  - 전자상거래 플랫폼에서 주문 생성, 결제, 배송 등의 각 단계 이벤트를 기록하여, 주문 상태 변화를 명확히 추적합니다.
- **사용자 활동 로그:**  
  - 소셜 미디어 및 로그 분석 시스템에서 사용자 행동 이벤트를 기록하여, 데이터를 기반으로 한 인사이트 도출 및 맞춤형 서비스를 제공합니다.

---

## 6. 참고 자료

- 📖 _Designing Data-Intensive Applications_ - Martin Kleppmann  
- 온라인 자료: [Event Sourcing Explained (Martin Fowler)](https://martinfowler.com/eaaDev/EventSourcing.html)  
- 관련 블로그 및 기술 문서: [Understanding Event Sourcing](https://www.eventstore.com/blog/)

---

## 7. 마무리

이벤트 소싱은 분산 시스템에서 데이터 상태 변경을 효과적으로 관리하고, 모든 변경 이력을 투명하게 기록하여 감사, 복구, 분석 기능을 강화할 수 있는 강력한 아키텍처 패턴입니다.  
전통적인 CRUD 방식과 비교하여, 이벤트 소싱은 데이터 정합성, 확장성, 그리고 비즈니스 인사이트 도출 측면에서 큰 장점을 제공합니다.  
실무에서는 이벤트 저장소 관리, 이벤트 스키마 버전 관리, 상태 재구성 최적화 등의 고려사항을 충분히 검토한 후 도입하는 것이 중요합니다.