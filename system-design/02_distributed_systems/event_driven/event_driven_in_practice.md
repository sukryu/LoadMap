# 실무에서의 이벤트 기반 아키텍처 적용

> **목표:**  
> - 이벤트 기반 아키텍처의 원리와 구성 요소를 실제 시스템에 어떻게 적용하는지 이해한다.  
> - 메시지 큐, 이벤트 소싱, CQRS 등의 패턴을 활용하여 비동기 처리, 확장성, 고가용성을 달성하는 방법을 연구한다.  
> - 이벤트 중복, 순서 보장, 내구성 등의 운영 이슈에 대응하기 위한 전략을 마련한다.

---

## 1. 개념 및 필요성

분산 시스템 환경에서 여러 서비스나 노드가 서로 독립적으로 동작하더라도, 전체 시스템의 상태를 일관되게 관리하고 확장성, 가용성을 보장하려면 이벤트 기반 아키텍처가 필수적입니다.  
실무에서는 다음과 같은 문제들을 해결하기 위해 이벤트 기반 접근 방식을 채택합니다:

- **비동기 통신:**  
  - 서비스 간 의존성을 줄이고, 요청-응답 모델의 병목현상을 해소할 수 있습니다.
  
- **확장성 및 고가용성:**  
  - 메시지 큐를 통한 부하 분산 및 이벤트 로그 기반의 내구성 있는 데이터 처리를 통해, 트래픽 급증이나 장애 상황에도 안정적인 서비스를 제공합니다.
  
- **감사 및 데이터 추적:**  
  - 모든 상태 변경을 이벤트로 기록하여, 나중에 감사(audit)나 디버깅, 상태 복원을 위한 기반 자료로 활용할 수 있습니다.

---

## 2. 적용 전략 및 접근 방식

### 2.1 아키텍처 설계

- **서비스 분리 및 느슨한 결합:**  
  - 각 서비스는 이벤트를 발행(Producer)하고 구독(Consumer)하는 형태로 독립적으로 동작합니다.  
  - 서비스 간 직접적인 호출 대신 메시지 큐나 이벤트 버스를 활용하여 느슨한 결합(loose coupling)을 유지합니다.

- **비동기 처리:**  
  - 이벤트 기반 아키텍처는 비동기 메시징을 기본으로 하여, 서비스 간 통신 지연이나 장애에도 전체 시스템이 영향을 최소화하도록 설계합니다.
  
- **읽기/쓰기 분리 (CQRS):**  
  - 쓰기 작업은 이벤트 로그를 기반으로 처리하고, 읽기 작업은 별도의 읽기 전용 데이터베이스나 캐시로 최적화하여 응답성을 향상시킵니다.

### 2.2 기술 스택 선택

- **메시지 큐:**  
  - Apache Kafka, RabbitMQ, Amazon SQS 등 중 시스템 요구사항(처리량, 확장성, 내구성 등)에 맞는 메시지 브로커를 선택합니다.
  
- **이벤트 저장소:**  
  - 이벤트 소싱을 도입하는 경우, 이벤트 로그를 저장할 내구성 있는 저장소(Event Store)를 구성합니다.
  
- **실시간 데이터 처리:**  
  - Kafka Streams, Apache Flink, Spark Streaming 등의 스트림 처리 기술을 통해, 이벤트를 실시간으로 처리하고 후속 작업을 수행합니다.

### 2.3 구현 방식

- **오케스트레이션 vs. 체인 방식:**  
  - **오케스트레이션 방식:** 중앙 조정자(Orchestrator)가 전체 이벤트 흐름을 관리합니다.  
    - 장점: 전체 흐름을 중앙에서 제어하므로 가시성이 높음  
    - 단점: 중앙 장애점(SPOF) 발생 가능
  - **체인 방식 (Choreography):** 각 서비스가 이벤트를 발행하고, 이를 구독하여 스스로 후속 작업을 수행합니다.  
    - 장점: 중앙 조정자가 없으므로 확장성이 높고 단일 장애점이 없음  
    - 단점: 전체 이벤트 흐름 파악이 어려워질 수 있으며, 서비스 간 협업을 위한 명확한 프로토콜이 필요함

- **이벤트 중복 처리 및 순서 보장:**  
  - 메시지 큐나 이벤트 버스에서 동일 이벤트가 중복 전송될 수 있으므로, 소비자는 이벤트 ID나 버전 정보를 통해 중복 처리를 방지해야 합니다.
  - 이벤트 순서 보장이 중요한 경우, 파티션 키를 적절히 설정하거나, 순서 보장 기능이 내장된 메시지 브로커(Kafka 등)를 활용합니다.

---

## 3. 운영 및 모니터링

- **모니터링 도구:**  
  - Prometheus, Grafana, ELK 스택 등을 활용하여, 메시지 큐의 상태, 이벤트 처리 지연, 소비자 그룹의 동작 상태 등을 실시간으로 모니터링합니다.
  
- **장애 대응 전략:**  
  - 이벤트 처리 중 장애가 발생했을 때 재시도 로직, 데드 레터 큐(Dead Letter Queue)를 도입하여 문제 이벤트를 별도로 처리합니다.
  - 메시지 큐의 내구성 설정 및 복제 정책을 통해 데이터 손실을 방지하고, 이벤트 흐름의 이상 징후를 빠르게 감지할 수 있도록 합니다.

- **성능 테스트:**  
  - 부하 테스트와 스트레스 테스트를 통해, 이벤트 기반 아키텍처의 처리량과 응답 시간을 측정하고, 시스템 확장성을 검증합니다.

---

## 4. 실무 적용 사례

- **Uber:**  
  - 실시간 차량 배차 시스템에서 Kafka를 활용하여, 차량 위치, 배차 요청, 경로 변경 등의 이벤트를 빠르게 처리하고, 실시간 통계를 제공합니다.

- **Netflix:**  
  - 마이크로서비스 간 이벤트 기반 통신을 통해, 사용자 시청 이력, 추천 시스템, 로그 처리 등 다양한 서비스에서 높은 확장성과 장애 대응성을 구현합니다.

- **Amazon:**  
  - Amazon SQS와 AWS Lambda를 결합하여, 주문 처리, 알림 전송, 서버리스 이벤트 처리 등에서 자동 확장 및 고가용성을 달성합니다.

---

## 5. 고려 사항 및 트레이드오프

- **이벤트 순서 및 중복 처리:**  
  - 이벤트 순서를 보장할 필요가 있는 경우, 파티션 관리 및 순서 보장 메커니즘을 설계해야 합니다.
  - 중복 이벤트 처리 로직을 구현하여, 동일한 이벤트가 여러 번 처리되지 않도록 해야 합니다.
  
- **서비스 간 의존성:**  
  - 느슨한 결합을 유지하기 위해, 각 서비스가 독립적으로 동작하도록 설계하며, 이벤트 메시지 포맷과 스키마를 표준화합니다.
  
- **확장성 vs. 복잡성:**  
  - 이벤트 기반 아키텍처는 높은 확장성을 제공하지만, 설계와 구현, 운영의 복잡성이 증가할 수 있으므로, 초기 도입 시 충분한 테스트와 모니터링 전략이 필요합니다.

---

## 6. 추천 리소스

- 📖 _Designing Event-Driven Systems_ - Ben Stopford  
- 📖 _Building Event-Driven Microservices_ - Adam Bellemare  
- 📖 _Kafka: The Definitive Guide_ - Neha Narkhede 외  
- 📌 [Event Sourcing Explained (Martin Fowler)](https://martinfowler.com/eaaDev/EventSourcing.html)  
- 📌 [CQRS and Event Sourcing](https://microservices.io/patterns/data/cqrs.html)

---

## 7. 마무리

실무에서의 이벤트 기반 아키텍처 적용은 비동기 통신, 확장성, 고가용성을 달성하기 위한 효과적인 방법입니다.  
메시지 큐, 이벤트 소싱, CQRS 등의 패턴과 기술 스택을 적절히 활용하면, 대규모 트래픽과 장애 상황에도 유연하게 대응하는 시스템을 구축할 수 있습니다.  
이 문서를 통해 실무 적용 전략, 운영 방안, 그리고 주요 고려 사항들을 명확히 이해하고, 실제 프로젝트에 적용할 때 참고하시길 바랍니다.