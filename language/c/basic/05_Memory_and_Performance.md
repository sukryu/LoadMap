# 05. Memory and Performance

## 1. C 프로그램의 메모리 모델

C 프로그램은 실행 중 다음과 같은 메모리 영역을 사용합니다. 각각의 역할을 이해하면 메모리 관리와 최적화에 큰 도움이 됩니다.

### 메모리 영역
1. **코드 영역 (Text Segment)**
   - 실행 가능한 코드가 저장됩니다.
   - 읽기 전용이며, 함수와 명령어가 여기에 위치합니다.

2. **데이터 영역 (Data Segment)**
   - 초기화된 전역 변수와 정적 변수가 저장됩니다.
   - 프로그램 실행 동안 유지됩니다.

3. **BSS 영역 (BSS Segment)**
   - 초기화되지 않은 전역 변수와 정적 변수가 저장됩니다.
   - 프로그램 시작 시 0으로 초기화됩니다.

4. **힙 (Heap)**
   - 동적 메모리 할당을 위한 공간입니다.
   - 프로그래머가 직접 관리 (`malloc`, `free` 등 사용).

5. **스택 (Stack)**
   - 지역 변수와 함수 호출에 사용됩니다.
   - LIFO 구조로 함수 호출 시 생성되고 반환 시 제거됩니다.

#### 메모리 구조 다이어그램
```
높은 주소
+------------------+
|      스택        |
|        ↓         |
|      힙          |
|        ↑         |
|   BSS 영역       |
|   데이터 영역    |
|   코드 영역      |
+------------------+
낮은 주소
```

---

## 2. 메모리 관리

### 동적 메모리 할당
C 언어에서는 실행 중 메모리를 동적으로 할당할 수 있습니다. 이를 통해 프로그램의 유연성을 높일 수 있습니다.

#### 주요 함수
| 함수        | 설명                                           |
|-------------|------------------------------------------------|
| `malloc`    | 메모리 블록을 할당하며, 초기화하지 않음.         |
| `calloc`    | 초기화된 메모리 블록을 할당.                    |
| `realloc`   | 기존 메모리 블록의 크기를 조정.                 |
| `free`      | 할당된 메모리를 해제.                           |

#### 예제: `malloc` 사용
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int *arr = (int *)malloc(5 * sizeof(int));

    if (arr == NULL) {
        printf("메모리 할당 실패\n");
        return 1;
    }

    for (int i = 0; i < 5; i++) {
        arr[i] = i + 1;
    }

    for (int i = 0; i < 5; i++) {
        printf("%d ", arr[i]);
    }

    free(arr);  // 메모리 해제
    return 0;
}
```

### 메모리 누수 방지
- **메모리 누수**는 동적 메모리를 할당한 후 해제하지 않을 때 발생합니다.
- 모든 `malloc`, `calloc`, `realloc` 호출은 `free`로 메모리를 해제해야 합니다.

#### 예제: 메모리 누수 방지
```c
int *ptr = (int *)malloc(sizeof(int));
if (ptr != NULL) {
    *ptr = 10;
    printf("값: %d\n", *ptr);
    free(ptr);  // 메모리 해제
}
```

---

## 3. 성능 최적화 기법

### 캐시 친화적 프로그래밍
메모리 캐시를 효과적으로 활용하면 프로그램의 성능을 크게 향상시킬 수 있습니다.

#### 데이터 지역성
- **시간적 지역성**: 최근에 접근한 데이터는 곧 다시 접근될 가능성이 높습니다.
- **공간적 지역성**: 가까운 메모리 주소에 있는 데이터는 함께 접근될 가능성이 높습니다.

#### 예제: 배열 순회 최적화
```c
// 캐시 친화적 코드
for (int i = 0; i < rows; i++) {
    for (int j = 0; j < cols; j++) {
        process(matrix[i][j]);
    }
}

// 캐시 비효율적 코드
for (int j = 0; j < cols; j++) {
    for (int i = 0; i < rows; i++) {
        process(matrix[i][j]);
    }
}
```

### 메모리 정렬
구조체 멤버의 메모리 정렬은 성능에 영향을 미칠 수 있습니다.

#### 패딩과 정렬
```c
struct Example {
    char a;     // 1바이트
    int b;      // 4바이트
    char c;     // 1바이트
};
// 실제 크기: 12바이트 (패딩 포함)

struct Optimized {
    int b;      // 4바이트
    char a;     // 1바이트
    char c;     // 1바이트
    char pad[2]; // 명시적 패딩
};
// 실제 크기: 8바이트
```

---

## 4. 비트 연산과 비트 마스크

### 비트 연산
비트 단위로 데이터를 조작하면 메모리를 절약하고, 성능을 높일 수 있습니다.

#### 주요 연산자
| 연산자  | 설명                | 예시        |
|---------|---------------------|-------------|
| `&`     | 비트 AND            | `a & b`     |
| `|`     | 비트 OR             | `a | b`     |
| `^`     | 비트 XOR            | `a ^ b`     |
| `~`     | 비트 NOT            | `~a`        |
| `<<`    | 왼쪽 시프트         | `a << 2`    |
| `>>`    | 오른쪽 시프트       | `a >> 2`    |

#### 비트 마스크 활용 예제
```c
#define FLAG_A (1 << 0)
#define FLAG_B (1 << 1)
#define FLAG_C (1 << 2)

unsigned int flags = 0;

// 플래그 설정
flags |= FLAG_A;
flags |= FLAG_B;

// 플래그 확인
if (flags & FLAG_A) {
    printf("FLAG_A가 설정됨\n");
}

// 플래그 해제
flags &= ~FLAG_B;
```

---

## 5. 성능 분석 도구

### 주요 도구
- **Valgrind**: 메모리 누수 및 메모리 접근 오류 탐지.
- **gprof**: 코드의 성능 병목 지점 분석.
- **perf**: Linux 성능 분석 도구.

### 예제: Valgrind 사용
```bash
valgrind --leak-check=full ./program
```

---

## 6. 간단한 예제: 동적 배열 구현

### 프로그램
```c
#include <stdio.h>
#include <stdlib.h>

int main() {
    int n;
    printf("배열 크기를 입력하세요: ");
    scanf("%d", &n);

    int *arr = (int *)malloc(n * sizeof(int));
    if (arr == NULL) {
        printf("메모리 할당 실패\n");
        return 1;
    }

    for (int i = 0; i < n; i++) {
        arr[i] = i + 1;
    }

    printf("배열 요소: ");
    for (int i = 0; i < n; i++) {
        printf("%d ", arr[i]);
    }
    printf("\n");

    free(arr);
    return 0;
}
```

### 프로그램 설명
1. 사용자로부터 배열 크기를 입력받아 동적으로 메모리를 할당.
2. 배열을 초기화하고 출력.
3. 사용 후 메모리를 해제하여 누수를 방지.

---

이 장에서는 메모리 모델과 관리, 성능 최적화 기법, 그리고 메모리와 관련된 주요 기술들을 다뤘습니다. 이를 통해 더욱 효율적이고 안정적인 C 프로그램을 작성할 수 있습니다.

